#Run using snakemake -j1 --latency-wait 120 --use-conda


#Dependancies to be used - R / Rpackages: ShortRead / angsd / blast-legacy (v2.2.26) / blast (v2.2.31)
#conda env export --from-history > environment.yaml
#conda env create --name testenv --file environment.yaml


import os
import os.path



##### Load Input Files and usefull info  #####


SAMPLES=[]
SAMPLE_FILE=open('Samples.txt','r')
for line in SAMPLE_FILE:
    SAMPLES.append(line.strip())
print(SAMPLES)


CHROMOSOMES=[]
GENES=[]
GENES_TO_REFERENCES={}
GENE_LOCS=open("Gene_locs.txt","r")
for line in GENE_LOCS:
    line=line.strip().split()
    CHROMOSOMES.append(line[1])
    GENES.append(line[0])
    GENES_TO_REFERENCES[line[0]]=line[4]
    

CHROMOSOMES=list(set(CHROMOSOMES))
CHROMOSOMES.sort()
print(CHROMOSOMES)
print(GENES)
print(GENES_TO_REFERENCES)

STARTS='./starts.txt'

PROT_REF_FILES='./Genes_human/'

EIT='./EIT/';

GENE_LOCS='./Gene_locs.txt';


#######################################################################################################################################################################
## Starting Rule

rule all:
    input:
        expand("Workspace/9_FINAL_OUTPUT/ALL_PROT_REFERENCE.fa"),
        expand("Workspace/9_FINAL_OUTPUT/PER_PROTEIN/{GENE}_PROT_REFERENCE.fa",GENE=GENES),
        expand("Workspace/9_FINAL_OUTPUT/PER_SAMPLE/{sample}_PROT_REFERENCE.fa",sample=SAMPLES)






#######################################################################################################################################################################
## Data Pipeline ##


#Make sure bam file has correct chromosome naming scheme

rule format_name:
    input:
        "Workspace/1_OG_BAM_FILES/{sample}.bam"
    output:
        "Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam"
    shell: 
        """samtools view -H {input} |\
        sed -e 's/SN:1/SN:chr1/' | sed -e 's/SN:2/SN:chr2/' | \
        sed -e 's/SN:3/SN:chr3/' | sed -e 's/SN:4/SN:chr4/' | \
        sed -e 's/SN:5/SN:chr5/' | sed -e 's/SN:6/SN:chr6/' | \
        sed -e 's/SN:7/SN:chr7/' | sed -e 's/SN:8/SN:chr8/' | \
        sed -e 's/SN:9/SN:chr9/' | sed -e 's/SN:10/SN:chr10/' | \
        sed -e 's/SN:11/SN:chr11/' | sed -e 's/SN:12/SN:chr12/' | \
        sed -e 's/SN:13/SN:chr13/' | sed -e 's/SN:14/SN:chr14/' | \
        sed -e 's/SN:15/SN:chr15/' | sed -e 's/SN:16/SN:chr16/' | \
        sed -e 's/SN:17/SN:chr17/' | sed -e 's/SN:18/SN:chr18/' | \
        sed -e 's/SN:19/SN:chr19/' | sed -e 's/SN:20/SN:chr20/' | \
        sed -e 's/SN:21/SN:chr21/' | sed -e 's/SN:22/SN:chr22/' | \
        sed -e 's/SN:X/SN:chrX/' | sed -e 's/SN:Y/SN:chrY/' | \
        sed -e 's/SN:MT/SN:chrM/' | samtools reheader - {input} > {output}"""



#Re Index it
rule format_index_name:
    input:
        "Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam"
    output:
        "Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam.bai"
    shell:
        "samtools index -b {input}"



#Split it into target chromosomes
rule format_split_into_chromosomes:
    input:
        BAM=expand("Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam",sample=SAMPLES),
        BAI=expand("Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam.bai",sample=SAMPLES),
        GENE_LOCS="Gene_locs.txt",
    output:
        expand("Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam", CHR=CHROMOSOMES,sample=SAMPLES),
        expand("Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam.bai", CHR=CHROMOSOMES,sample=SAMPLES)
    run:
        COMMANDS1=expand("""samtools view -b Workspace/2_FORMATTED_BAM/{sample}_FRMT.bam chr{CHR} > Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam; """,CHR=CHROMOSOMES,sample=SAMPLES)
        COMMANDS2=expand("""samtools index -b Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam;  """,CHR=CHROMOSOMES,sample=SAMPLES)
        
        for CMD in COMMANDS1:
            shell(CMD)
        for CMD2 in COMMANDS2:
            shell(CMD2)



#####
#Maybe add another formating step here for samples that are already split into chromosomes
##
# def get_3_SPLIT_CHRoms_or_formatted_whole(wcs):
    # if:
        # return input1
    # if:
        # return input2
        

# rule format_split_into_chromosomes:
    # input:
        # BAM=get_3_SPLIT_CHRoms_or_formatted_whole,
        # GENE_LOCS="Gene_locs.txt",
    # output:
        # expand("BAM_FILES/DENISOVA_DENISOVA_ADNA_FRMT_{CHR}.bam", CHR=CHROMOSOMES)
    # run:
        # if input1:
            # NAME=input.BAM[:-4]
            # for CHR in CHROMOSOMES:
                # shell("""samtools view -b {} chr{} > {}_{}.bam; """.format(input.BAM,CHR,NAME,CHR))
        # if input2:
            # for CHR in CHROMOSOMES:
####


#Use ANGSD to transform to fasta
rule from_bam_to_fasta_ANGSD:
    input:
        expand("Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam",CHR=CHROMOSOMES,sample=SAMPLES),
        expand("Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam.bai",CHR=CHROMOSOMES,sample=SAMPLES)
    output:
        expand("Workspace/4_FASTA_FILES/{sample}_FRMT_{CHR}.fa.gz",CHR=CHROMOSOMES,sample=SAMPLES)

    run:
        #2 lists, one of ancient samples and one of modern ones
        #COMMANDS1=expand() #for ancient samples
        COMMANDS=expand("""angsd -minQ 20 -minMapQ 30 -doFasta 2 -doCounts 1 -basesPerLine 60 -i Workspace/3_SPLIT_CHR/{sample}_FRMT_{CHR}.bam -r chr{CHR} -out Workspace/4_FASTA_FILES/{sample}_FRMT_{CHR};""",CHR=CHROMOSOMES,sample=SAMPLES)
        for CMD in COMMANDS:
            shell(CMD)
        #check to see if all files were made. EG if a sample lacks a Y chromosome angsd wont run for that one and wont make the file
        #, thus we make a dummy file in its place so that the pipeline does nto crash!
        for sample in SAMPLES:
            for CHR in CHROMOSOMES:
                path='./Workspace/4_FASTA_FILES/{}_FRMT_{}.fa.gz'.format(sample,CHR)
                print(os.path.exists(path),path)
                if os.path.exists(path)==False:
                    shell('cp ./Workspace/1_OG_BAM_FILES/dummy.fa ./Workspace/4_FASTA_FILES/{}_FRMT_{}.fa'.format(sample,CHR))
                    shell('gzip ./Workspace/4_FASTA_FILES/{}_FRMT_{}.fa'.format(sample,CHR))



#######################################################################################################################################################################
##Actual DNA to Proteins Translation ##

#Use custom R scripts
#Isolate Gene segment from chromosome fasta


rule Isolate_Gene_from_fasta:
    input:
        expand("Workspace/4_FASTA_FILES/{sample}_FRMT_{CHR}.fa.gz",CHR=CHROMOSOMES,sample=SAMPLES)
    output:
        expand("Workspace/5_GENE_FASTA_FILES/{sample}_FRMT_{GENE}.fa",GENE=GENES,sample=SAMPLES)

    run:
        COMMANDS=expand("""Rscript ./R\ scripts/Rscript1.r Workspace/4_FASTA_FILES/{sample}_FRMT_{CHR}.fa.gz Gene_locs.txt Workspace/5_GENE_FASTA_FILES/;""",CHR=CHROMOSOMES,sample=SAMPLES)
        for CMD in COMMANDS:
            shell(CMD)


#Splice Gene segment from gene fasta, keep exones

rule Splice_Genes:
    input:
        expand("Workspace/5_GENE_FASTA_FILES/{sample}_FRMT_{GENE}.fa",GENE=GENES,sample=SAMPLES)
    output:
        expand("Workspace/6_SPLICED_GENE_FILES/{sample}_FRMT_{GENE}_spliced.fa",GENE=GENES,sample=SAMPLES)

    run:
        COMMANDS=expand("""Rscript ./R\ scripts/Rscript2.r Workspace/5_GENE_FASTA_FILES/{sample}_FRMT_{GENE}.fa starts.txt ./EIT/ Workspace/6_SPLICED_GENE_FILES/ ;""",GENE=GENES,sample=SAMPLES)
        for CMD in COMMANDS:
            shell(CMD)



rule Translate_through_blastools:
    input:
        expand("Workspace/6_SPLICED_GENE_FILES/{sample}_FRMT_{GENE}_spliced.fa",GENE=GENES,sample=SAMPLES)
    output:
        expand("Workspace/7_BLASTED_GENES/{sample}_FRMT_{GENE}_spliced.blast",GENE=GENES,sample=SAMPLES)
    run:
        COMMANDS1=expand("""makeblastdb -dbtype nucl -in Workspace/6_SPLICED_GENE_FILES/{sample}_FRMT_{GENE}_spliced.fa;""",GENE=GENES,sample=SAMPLES)
        
        
        for CMD in COMMANDS1:
            shell(CMD)
        for GENE in GENES:
            for sample in SAMPLES:
                shell("""blastall  -p tblastn -i ./Genes_human/{}  -d Workspace/6_SPLICED_GENE_FILES/{}_FRMT_{}_spliced.fa -o Workspace/7_BLASTED_GENES/{}_FRMT_{}_spliced.blast -F F -E 32767 -G 32767 -n T -m 0 -M PAM70;""".format(GENES_TO_REFERENCES[GENE],sample,GENE,sample,GENE))
                


rule Extract_blastools_output:
    input:
        expand("Workspace/7_BLASTED_GENES/{sample}_FRMT_{GENE}_spliced.blast",GENE=GENES,sample=SAMPLES)
    output:
        expand("Workspace/8_PROTEINS_FASTAS/{sample}_FRMT_{GENE}_translated.fa",GENE=GENES,sample=SAMPLES)
    run:
        COMMANDS1=expand("""Rscript R\ scripts/Rscript3.r ./Workspace/7_BLASTED_GENES/{sample}_FRMT_{GENE}_spliced.blast Workspace/8_PROTEINS_FASTAS/ ;""",GENE=GENES,sample=SAMPLES)
        for CMD in COMMANDS1:
            shell(CMD)
            
            
rule Assemble_protein_dataset:
    input:
        expand("Workspace/8_PROTEINS_FASTAS/{sample}_FRMT_{GENE}_translated.fa",GENE=GENES,sample=SAMPLES)
    output:
        expand("Workspace/9_FINAL_OUTPUT/ALL_PROT_REFERENCE.fa"),
        expand("Workspace/9_FINAL_OUTPUT/PER_PROTEIN/{GENE}_PROT_REFERENCE.fa",GENE=GENES),
        expand("Workspace/9_FINAL_OUTPUT/PER_SAMPLE/{sample}_PROT_REFERENCE.fa",sample=SAMPLES)
    run:
        COMMANDS1=expand("""touch Workspace/9_FINAL_OUTPUT/PER_PROTEIN/{GENE}_PROT_REFERENCE.fa; cat Workspace/8_PROTEINS_FASTAS/*_{GENE}_translated.fa >>Workspace/9_FINAL_OUTPUT/PER_PROTEIN/{GENE}_PROT_REFERENCE.fa; """,GENE=GENES)
        COMMANDS2=expand("""touch Workspace/9_FINAL_OUTPUT/PER_SAMPLE/{sample}_PROT_REFERENCE.fa; cat Workspace/8_PROTEINS_FASTAS/{sample}_FRMT_*_translated.fa >>Workspace/9_FINAL_OUTPUT/PER_PROTEIN/{sample}_PROT_REFERENCE.fa; """,sample=SAMPLES)
        
        for CMD in COMMANDS1:
            shell(CMD)
        for CMD in COMMANDS2:
            shell(CMD)    
        shell(""" cat Workspace/8_PROTEINS_FASTAS/*_translated.fa >>Workspace/9_FINAL_OUTPUT/ALL_PROT_REFERENCE.fa; """)    
        