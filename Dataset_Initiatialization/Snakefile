#Run using snakemake -j1 --latency-wait 120 --use-conda


#Dependancies to be used - R / Rpackages: ShortRead / angsd / blast-legacy (v2.2.26) / blast (v2.2.31)
#conda env export --from-history > environment.yaml
#conda env create --name testenv --file environment.yaml


import os
import os.path



##### Load Input Files and usefull info  #####


GENES=[]
ORGANISM=[]
REFERENCE=[]


PROTEIN_FILE=open('Proteins.txt','r')
for line in PROTEIN_FILE:
    GENES.append(line.strip())

print(GENES)



ORGANISM_FILE=open('Organism.txt','r')
for line in ORGANISM_FILE:
    line=line.strip().split('\t')
    ORGANISM.append(line[0])
    if (len(line)==2):
        REFERENCE.append(line[1])


print(GENES)
print(ORGANISM)
print(REFERENCE)


#######################################################################################################################################################################
## Starting Rule

rule all:
    input:
        expand("Workspace/1_Gene_IDs/{organism}/{sample}",sample=GENES,organism=ORGANISM)


#######################################################################################################################################################################
## Data Pipeline ##

####

rule Get_Ensembl_Gene_IDs:
    input:
        "Proteins.txt",
        "Organism.txt"
    output:
        expand("Workspace/1_Gene_IDs/{organism}/{sample}",sample=GENES,organism=ORGANISM),
        expand('Workspace/1_Gene_IDs/{organism}/Missing_IDs.txt',organism=ORGANISM)
    run:
        for ORG in ORGANISM:
            path='Workspace/1_Gene_IDs/'+str(ORG)
            if os.path.exists(path)==False:
                os.makedirs(path)
            
            for GENE in GENES:
                shell(""" python3 Python_Scripts/Search_Uniprot.py {} {}""".format(GENE,ORG))



rule Get_Ensembl_Transcript_IDs:
    input:
        expand("Workspace/1_Gene_IDs/{organism}/{sample}",sample=GENES,organism=ORGANISM),
        'Missing_IDs.txt'
    output:
        expand("Workspace/1_Gene_IDs/{organism}/{sample}",sample=GENES,organism=ORGANISM),
        'Missing_IDs.txt'
    run:
        MISSING_FILE=open('Missing_IDs.txt','r')
        MISSING_GENES=[]
        for line in MISSING_FILE:
            MISSING_GENES.append(line.strip())
        FOUND_GENES=[x for x in GENES if x not in MISSING_GENES]    
            
        for ORG in ORGANISM:
            for GENE in FOUND_GENES:
        
        for ORG